## 多线程的实现

此Demo是为了在公司没有多线程高并发场景时，但是需要提升多线程编程的能力，锻炼自己的一个小demo；

主要流程参考以下知乎回答[^1],以下是具体项目实现流程：

> **练习项目**：
>
> 1. 新建一个Java项目，可以是springboot项目或者用自己熟悉的框架。
> 2. 数据库建一个表，可以很简单，字段只需要主键id、姓名、年龄即可。
> 3. 在项目中实现增删改查、批量插入功能，写好接口，留着后面调用。
> 4. client可以是一个简单的main方法或是接口
> 5. **测试批量插入一万条数据，数据库会响应很慢，可以在调用前后打印耗时时间。**
> 6. **优化批量插入，例如将一万条数据分批每次插入200条。可以在循环里做，但使用多线程来执行更优。为什么？因为在循环里执行，数据库压力问题无法解决。使用线程池管理线程，然后异步插入。(这里会有数据连接浪费资源的问题、插入失败问题，暂且不考虑，以用多线程为目的。)**
> 7. **在测试一个，写一个方法，获取一个用户的年龄，每次对年龄做自增1，然后更新到数据库。创建10个线程同时调用，看看最后数据库里的年龄是否增加了10岁。多调用几次，会发现年龄-原来的小于10，这就是多线程中常遇到的并发问题，造成了脏数据。**
> 8. **解决脏数据问题，将查询、自增1、更新三个操作保证[原子性](https://www.zhihu.com/search?q=原子性&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra={"sourceType"%3A"answer"%2C"sourceId"%3A1760848443})，并加锁，保证同一时间只有一个人来操作。**

在第六步时实现批量插入，选择使用线程池去实现异步插入。而关于线程池的使用，参考了此博主讲解[^2]，例子丰富，基本可以套用

## 部分过程

获取一万条数据

![image-20230301231225645](https://cdn.jsdelivr.net/gh/docker200/PicGo-Resource@main/202303020054735.png)

前台接口一次插入一万条，同时插入十次。后台使用`<insert>`直接插入

![image-20230301232720153](https://cdn.jsdelivr.net/gh/docker200/PicGo-Resource@main/202303020054447.png)



前台接口一次插入一万条，同时插入十次。但是后台使用Guava批量插入，即插入两百后分片插入的优化。少了100ms

![image-20230301234323213](https://cdn.jsdelivr.net/gh/docker200/PicGo-Resource@main/202303020054410.png)

在上一步的基础上，使用线程池对插入一万条数据，创建最大线程数为10的线程插入。。少了280ms。此时核心线程1

![image-20230302001353631](https://cdn.jsdelivr.net/gh/docker200/PicGo-Resource@main/202303020054298.png)
在上一步的基础上，使用线程池对插入10万条数据。反而增加了平均时间。此时核心线程2。重试一次，恢复至280ms。原因分析：应是第一次创建网络连接耗时了大头时间，导致平均时长上升





## 参考链接

- [^1]:[公司项目中java的多线程一般用在哪些场景？自己想练手多线程的话，搞一个什么样的demo比较合适](https://www.zhihu.com/question/442481860/answer/1760848443)

- [^2]: [线程池最优使用策略【Java线程池学习一】](https://www.bilibili.com/video/BV16M411P7Sg/?spm_id_from=333.999.0.0&vd_source=d9cf24ea1862dda7e4a86a40d0eab7f2)

  

